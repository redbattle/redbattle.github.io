---
title: Github 自动化部署
date: 2021-09-23 15:26:07
permalink: /pages/8cd84a/
categories:
  - project
tags:
  - 
---

### 准备工作
- 在 `package.json` 文件的 `scripts` 里加入 `build`，`deploy` 命令
  ```
  "scripts": {
    "build": "vuepress build docs",
    "deploy": "bash deploy.sh"
  },
  ```

- 修改当前github仓库的 `Settings/Pages` 里面Source的分支改为 `gh-pages`

### 方法一：本地 deploy 部署代码
- 新建 `deploy.sh` 文件
  ```sh
  #!/usr/bin/env sh
  # 确保脚本抛出遇到的错误
  set -e
  npm run build # 生成静态文件
  cd docs/.vuepress/dist # 进入生成的文件夹

  git init
  git add .
  git commit -m 'deploy'
  git push -f git@github.com:redbattle/redbattle.github.io.git master:gh-pages # 推送到github的gh-pages分支

  ```
- 本地执行 deploy
  ```
  npm run deploy
  ```

### 方法二：通过 Github action 部署代码
- 按照[官方文档](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token) ，生成一个 `github token` (令牌)。

- 将这个密钥储存到当前github仓库的 `Settings/Secrets` 里面。

- 新建 `deploy.sh` 文件
  ```sh
  #!/usr/bin/env sh
  # 确保脚本抛出遇到的错误
  set -e
  npm run build # 生成静态文件
  cd docs/.vuepress/dist # 进入生成的文件夹

  if [ -z "$GITHUB_TOKEN" ]; then
    msg='deploy'
    githubUrl=git@github.com:redbattle/redbattle.github.io.git
  else
    msg='来自github action的自动部署'
    githubUrl=https://redbattle:${GITHUB_TOKEN}@github.com/redbattle/redbattle.github.io.git
    git config --global user.name "redbattle"
    git config --global user.email "zhaiyu_hb@hotmail.com"
  fi

  git init
  git add .
  git commit -m "${msg}"
  git push -f $githubUrl master:gh-pages # 推送到github的gh-pages分支

  cd -
  rm -rf docs/.vuepress/dist
  ```

- 新建 `.github/workflows/ci.yml` 文件，`GitHub Action` 会自动运行该文件
  ```yml
  name: CI
  # 在master分支发生push事件时触发。
  on:
    push:
      branches:
        - master
  jobs: # 工作流
    build:
      runs-on: ubuntu-latest #运行在虚拟机环境ubuntu-latest

      strategy:
        matrix:
          node-version: [12.x]

      steps:
        - name: Checkout # 步骤1
          uses: actions/checkout@v1 # 使用的动作。格式：userName/repoName。作用：检出仓库，获取源码。 官方actions库：https://github.com/actions
        - name: Use Node.js ${{ matrix.node-version }} # 步骤2
          uses: actions/setup-node@v1 # 作用：安装nodejs
          with:
            node-version: ${{ matrix.node-version }} # 版本
        - name: run deploy.sh # 步骤3 （同时部署到github和coding）
          env: # 设置环境变量
            GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }} # toKen私密变量
            # CODING_TOKEN: ${{ secrets.CODING_TOKEN }} # 腾讯云开发者平台（coding）私密token
          run: npm install && npm run deploy # 执行的命令
          # package.json 中添加 "deploy": "bash deploy.sh"
  ```